<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Pesanan - nazzstore</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a5f; --primary-light: #2d4a6f; --secondary: #3b82f6;
      --white: #ffffff; --gray-50: #f9fafb; --gray-100: #f3f4f6;
      --gray-200: #e5e7eb; --gray-300: #d1d5db; --gray-400: #9ca3af;
      --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
      --gray-800: #1f2937; --gray-900: #111827;
      --success: #10b981; --success-light: #d1fae5;
      --error: #ef4444; --error-light: #fee2e2;
      --info: #3b82f6; --info-light: #dbeafe;
      --warning: #f59e0b; --warning-light: #fef3c7;
      --shadow: 0 1px 3px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px rgb(0 0 0 / 0.1);
      --radius: 0.5rem; --radius-lg: 1rem;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.6; min-height: 100vh; }
    .container { max-width: 600px; margin: 0 auto; padding: 1.5rem; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.9375rem; font-weight: 500; border: none; border-radius: var(--radius); cursor: pointer; transition: all 0.3s; text-decoration: none; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-success { background: var(--success); color: var(--white); }
    .btn-secondary { background: var(--white); color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }

    .navbar { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .navbar-brand { font-size: 1.25rem; font-weight: 700; color: var(--primary); text-decoration: none; }

    .order-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; margin-bottom: 1rem; }
    .order-header { padding: 1.5rem; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); text-align: center; }
    .order-id { font-size: 0.8125rem; opacity: 0.9; margin-bottom: 0.5rem; }
    .order-header h2 { font-size: 1.25rem; margin-bottom: 0.75rem; }
    .order-body { padding: 1.5rem; }

    .order-section { margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--gray-100); }
    .order-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .section-title { font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-400); margin-bottom: 0.75rem; }
    .order-row { display: flex; justify-content: space-between; padding: 0.375rem 0; }
    .order-label { color: var(--gray-500); font-size: 0.875rem; }
    .order-value { font-weight: 500; color: var(--gray-900); font-size: 0.875rem; text-align: right; }
    .order-total { font-size: 1.125rem; color: var(--primary); }

    .badge { display: inline-block; padding: 0.375rem 0.875rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.025em; }
    .badge-pending { background: var(--gray-200); color: var(--gray-700); }
    .badge-waiting { background: var(--info-light); color: var(--info); }
    .badge-success { background: var(--success-light); color: var(--success); }
    .badge-error { background: var(--error-light); color: var(--error); }

    .upload-section { padding: 1.5rem; background: var(--gray-50); border-top: 1px solid var(--gray-100); }
    .upload-title { font-size: 0.9375rem; font-weight: 600; margin-bottom: 1rem; color: var(--gray-800); }
    
    .upload-area { border: 2px dashed var(--gray-300); border-radius: var(--radius-lg); padding: 2rem 1rem; text-align: center; cursor: pointer; background: var(--white); transition: all 0.3s; position: relative; }
    .upload-area:hover { border-color: var(--primary); background: rgba(30,58,95,0.02); }
    .upload-area.dragover { border-color: var(--primary); background: rgba(30,58,95,0.05); }
    .upload-area.has-file { border-style: solid; border-color: var(--success); }
    
    .upload-icon { width: 48px; height: 48px; margin: 0 auto 0.75rem; background: var(--gray-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--gray-400); }
    .upload-text { color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.25rem; }
    .upload-hint { font-size: 0.75rem; color: var(--gray-400); }
    
    .upload-preview { margin-top: 1rem; position: relative; display: inline-block; }
    .upload-preview img { max-width: 100%; max-height: 200px; border-radius: var(--radius); border: 1px solid var(--gray-200); }
    .upload-preview .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--error); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    
    .file-info { margin-top: 0.75rem; padding: 0.75rem; background: var(--success-light); border-radius: var(--radius); font-size: 0.8125rem; color: var(--success); }
    
    .upload-progress { margin-top: 1rem; }
    .progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 4px; transition: width 0.3s; }
    .progress-text { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem; text-align: center; }

    .result-box { padding: 1.5rem; text-align: center; border-radius: var(--radius-lg); margin: 1rem; }
    .result-box.success { background: var(--success-light); color: var(--success); }
    .result-box.error { background: var(--error-light); color: var(--error); }
    .result-box.waiting { background: var(--info-light); color: var(--info); }
    .result-box h3 { font-size: 1rem; margin: 0.5rem 0 0.25rem; }
    .result-box p { font-size: 0.875rem; opacity: 0.9; }

    .copy-btn { background: none; border: 1px solid var(--gray-300); padding: 0.25rem 0.5rem; font-size: 0.6875rem; border-radius: 4px; cursor: pointer; color: var(--gray-600); margin-left: 0.5rem; }
    .copy-btn:hover { background: var(--gray-100); }

    .spinner { width: 20px; height: 20px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-state { text-align: center; padding: 4rem 2rem; }
    .error-state { text-align: center; padding: 3rem 2rem; }

    .toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 2000; }
    .toast { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-lg); margin-bottom: 0.5rem; transform: translateX(150%); transition: transform 0.3s; font-size: 0.875rem; min-width: 280px; }
    .toast.show { transform: translateX(0); }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--error); }

    .help-section { text-align: center; margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: var(--radius); }
    .help-section p { font-size: 0.875rem; color: var(--gray-500); }
    .help-section a { color: var(--success); font-weight: 500; }

    .maintenance-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--gray-100); text-align: center; }
    .maintenance-icon { width: 80px; height: 80px; margin: 0 auto 1.5rem; background: var(--warning-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--warning); }
  </style>
</head>
<body>
  <!-- Maintenance -->
  <div id="maintenancePage" class="maintenance-page" style="display:none;">
    <div>
      <div class="maintenance-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <h1 style="font-size:1.5rem;margin-bottom:0.5rem;">Sedang Maintenance</h1>
      <p style="color:var(--gray-500);">Silakan kembali beberapa saat lagi.</p>
    </div>
  </div>

  <!-- Main -->
  <div id="mainContent">
    <nav class="navbar">
      <a href="index.html" class="navbar-brand">üíé nazzstore</a>
      <a href="topup.html" class="btn btn-primary btn-sm">Top Up Lagi</a>
    </nav>

    <div class="container">
      <!-- Loading State -->
      <div id="loadingState" class="order-card loading-state">
        <div class="spinner" style="width: 40px; height: 40px; color: var(--primary);"></div>
        <p style="margin-top: 1rem; color: var(--gray-500);">Memuat pesanan...</p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="order-card error-state" style="display:none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--gray-300)" stroke-width="1.5" style="margin-bottom:1rem;">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">Pesanan Tidak Ditemukan</h3>
        <p style="color: var(--gray-500); margin-bottom: 1.5rem;">ID pesanan tidak valid atau sudah dihapus</p>
        <a href="topup.html" class="btn btn-primary">Buat Pesanan Baru</a>
      </div>

      <!-- Order Details -->
      <div id="orderDetails" class="order-card" style="display:none;">
        <div class="order-header">
          <p class="order-id">Order ID: <strong id="orderId">-</strong></p>
          <h2>Detail Pesanan</h2>
          <div id="statusBadge"></div>
        </div>

        <div class="order-body">
          <!-- Product Info -->
          <div class="order-section">
            <h4 class="section-title">Produk</h4>
            <div class="order-row">
              <span class="order-label">Nama</span>
              <span class="order-value" id="prodName">-</span>
            </div>
            <div class="order-row">
              <span class="order-label">Diamond</span>
              <span class="order-value" id="prodDiamond">-</span>
            </div>
            <div class="order-row">
              <span class="order-label">Total Bayar</span>
              <span class="order-value order-total" id="prodPrice">-</span>
            </div>
          </div>

          <!-- Account Info -->
          <div class="order-section">
            <h4 class="section-title">Akun</h4>
            <div class="order-row">
              <span class="order-label">ID Free Fire</span>
              <span class="order-value" id="accFFId">-</span>
            </div>
            <div class="order-row">
              <span class="order-label">WhatsApp</span>
              <span class="order-value" id="accWA">-</span>
            </div>
          </div>

          <!-- Payment Info -->
          <div class="order-section">
            <h4 class="section-title">Pembayaran</h4>
            <div class="order-row">
              <span class="order-label">Metode</span>
              <span class="order-value" id="payMethod">-</span>
            </div>
            <div class="order-row">
              <span class="order-label">Transfer ke</span>
              <span class="order-value">
                <span id="payNumber">-</span>
                <button class="copy-btn" onclick="copyNumber()">Salin</button>
              </span>
            </div>
            <div class="order-row">
              <span class="order-label">Waktu</span>
              <span class="order-value" id="orderTime">-</span>
            </div>
          </div>
        </div>

        <!-- Upload Section (PENDING) -->
        <div id="uploadSection" class="upload-section" style="display:none;">
          <h4 class="upload-title">üì∏ Upload Bukti Transfer</h4>
          <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
            <div class="upload-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
            </div>
            <p class="upload-text">Klik atau drag foto bukti transfer</p>
            <p class="upload-hint">JPG, PNG (Maks 2MB) - Akan dikompresi otomatis</p>
          </div>
          
          <div id="previewContainer" style="display:none;">
            <div class="upload-preview">
              <img id="previewImg" src="" alt="Preview">
              <button class="remove-btn" onclick="removeFile()">‚úï</button>
            </div>
            <div class="file-info" id="fileInfo"></div>
          </div>
          
          <div class="upload-progress" id="progressContainer" style="display:none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p class="progress-text" id="progressText">Mengupload... 0%</p>
          </div>
          
          <button id="uploadBtn" class="btn btn-success" style="width:100%;margin-top:1rem;" disabled>
            <span id="uploadBtnText">Upload Bukti Transfer</span>
            <span id="uploadSpinner" class="spinner" style="display:none;"></span>
          </button>
        </div>

        <!-- Waiting Confirmation -->
        <div id="waitingSection" class="upload-section" style="display:none;">
          <div class="result-box waiting">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            <h3>Menunggu Konfirmasi</h3>
            <p>Bukti transfer sudah diupload. Admin akan segera memproses pesanan Anda.</p>
          </div>
          <div style="text-align:center;margin-top:1rem;">
            <p style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:0.5rem;">Bukti yang diupload:</p>
            <img id="uploadedProofImg" src="" alt="Bukti" style="max-width:100%;max-height:200px;border-radius:var(--radius);border:1px solid var(--gray-200);">
          </div>
        </div>

        <!-- Success -->
        <div id="successSection" class="upload-section" style="display:none;">
          <div class="result-box success">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <h3>Pesanan Berhasil! üéâ</h3>
            <p>Diamond telah dikirim ke akun Free Fire Anda</p>
          </div>
        </div>

        <!-- Rejected -->
        <div id="rejectedSection" class="upload-section" style="display:none;">
          <div class="result-box error">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <h3>Pesanan Ditolak</h3>
            <p>Hubungi admin untuk informasi lebih lanjut</p>
          </div>
        </div>
      </div>

      <!-- Help Section -->
      <div id="helpSection" class="help-section" style="display:none;">
        <p>Jika pesanan masih pending hubungi admin di bawah ini</p>
        <p>Butuh bantuan? <a href="https://wa.me/62895324565588" target="_blank">Chat WhatsApp</a></p>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ö†Ô∏è GANTI DENGAN CONFIG FIREBASE ANDA
    const firebaseConfig = {
      apiKey: "AIzaSyD8WMVLi4chPIJYkZtubPC787pSI36UMQk",
      authDomain: "nazzstorenieh.firebaseapp.com",
      projectId: "nazzstorenieh",
      storageBucket: "nazzstorenieh.firebasestorage.app",
      messagingSenderId: "120598483627",
      appId: "1:120598483627:web:83641541facb2aa2b91dee"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // State
    let currentOrder = null;
    let orderDocId = null;
    let selectedFile = null;
    let compressedFile = null;

    // Utils
    const formatCurrency = n => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
    const formatNumber = n => new Intl.NumberFormat('id-ID').format(n || 0);
    const formatDate = ts => {
      if (!ts) return '-';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    };

    function getStatusBadge(status) {
      const map = {
        'PENDING': ['badge-pending', 'Menunggu Pembayaran'],
        'MENUNGGU KONFIRMASI': ['badge-waiting', 'Menunggu Konfirmasi'],
        'SUKSES': ['badge-success', 'Sukses'],
        'DITOLAK': ['badge-error', 'Ditolak']
      };
      const [cls, txt] = map[status] || map['PENDING'];
      return `<span class="badge ${cls}">${txt}</span>`;
    }

    function toast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      document.getElementById('toastContainer').appendChild(t);
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 4000);
    }

    window.copyNumber = () => {
      if (currentOrder?.paymentNumber) {
        navigator.clipboard.writeText(currentOrder.paymentNumber);
        toast('Nomor disalin!');
      }
    };

    // Compress image function - PENTING untuk upload cepat
    function compressImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Resize if too large
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              if (blob) {
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              } else {
                reject(new Error('Gagal kompres gambar'));
              }
            }, 'image/jpeg', quality);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Convert file to base64 untuk simpan langsung di Firestore
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // Load Order
    async function loadOrder() {
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('id');

      if (!orderId) {
        showError();
        return;
      }

      try {
        console.log('Loading order:', orderId);
        
        // Find order by orderId field
        const ordersRef = collection(db, 'orders');
        const q = query(ordersRef, where('orderId', '==', orderId));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          showError();
          return;
        }

        const docSnap = snapshot.docs[0];
        currentOrder = { id: docSnap.id, ...docSnap.data() };
        orderDocId = docSnap.id;
        
        console.log('Order loaded:', currentOrder);
        renderOrder();

      } catch (error) {
        console.error('Error loading order:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }

    function renderOrder() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('orderDetails').style.display = 'block';
      document.getElementById('helpSection').style.display = 'block';

      // Populate data
      document.getElementById('orderId').textContent = currentOrder.orderId;
      document.getElementById('statusBadge').innerHTML = getStatusBadge(currentOrder.status);
      document.getElementById('prodName').textContent = currentOrder.productName || '-';
      document.getElementById('prodDiamond').textContent = formatNumber(currentOrder.diamondAmount) + ' üíé';
      document.getElementById('prodPrice').textContent = formatCurrency(currentOrder.price);
      document.getElementById('accFFId').textContent = currentOrder.ffId || '-';
      document.getElementById('accWA').textContent = currentOrder.whatsapp || '-';
      document.getElementById('payMethod').textContent = currentOrder.paymentMethod || '-';
      document.getElementById('payNumber').textContent = currentOrder.paymentNumber || '-';
      document.getElementById('orderTime').textContent = formatDate(currentOrder.createdAt);

      updateUI();
    }

    function updateUI() {
      // Hide all sections first
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('waitingSection').style.display = 'none';
      document.getElementById('successSection').style.display = 'none';
      document.getElementById('rejectedSection').style.display = 'none';

      switch (currentOrder.status) {
        case 'PENDING':
          document.getElementById('uploadSection').style.display = 'block';
          break;
        case 'MENUNGGU KONFIRMASI':
          document.getElementById('waitingSection').style.display = 'block';
          if (currentOrder.proofImage) {
            document.getElementById('uploadedProofImg').src = currentOrder.proofImage;
          }
          break;
        case 'SUKSES':
          document.getElementById('successSection').style.display = 'block';
          break;
        case 'DITOLAK':
          document.getElementById('rejectedSection').style.display = 'block';
          break;
      }

      // Update status badge
      document.getElementById('statusBadge').innerHTML = getStatusBadge(currentOrder.status);
    }

    // Upload handlers
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewContainer = document.getElementById('previewContainer');
    const previewImg = document.getElementById('previewImg');
    const fileInfo = document.getElementById('fileInfo');

    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    });

    async function handleFile(file) {
      // Validate
      if (!file.type.startsWith('image/')) {
        toast('Hanya file gambar yang diperbolehkan', 'error');
        return;
      }

      const maxSize = 5 * 1024 * 1024; // 5MB max before compression
      if (file.size > maxSize) {
        toast('File terlalu besar (maks 5MB)', 'error');
        return;
      }

      selectedFile = file;
      
      // Show preview immediately
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
        uploadArea.style.display = 'none';
      };
      reader.readAsDataURL(file);

      // Compress in background
      try {
        fileInfo.textContent = `‚è≥ Mengompres gambar...`;
        
        compressedFile = await compressImage(file, 800, 0.7);
        
        const originalSize = formatFileSize(file.size);
        const compressedSize = formatFileSize(compressedFile.size);
        
        fileInfo.innerHTML = `‚úÖ <strong>${file.name}</strong><br>Ukuran: ${originalSize} ‚Üí ${compressedSize}`;
        uploadBtn.disabled = false;
        
      } catch (error) {
        console.error('Compression error:', error);
        // Use original file if compression fails
        compressedFile = file;
        fileInfo.textContent = `‚úÖ ${file.name} (${formatFileSize(file.size)})`;
        uploadBtn.disabled = false;
      }
    }

    window.removeFile = () => {
      selectedFile = null;
      compressedFile = null;
      fileInput.value = '';
      previewContainer.style.display = 'none';
      uploadArea.style.display = 'block';
      uploadBtn.disabled = true;
    };

    // Upload to Firestore (as base64 - FAST!)
    uploadBtn.addEventListener('click', async () => {
      if (!compressedFile || !currentOrder) return;

      const btnText = document.getElementById('uploadBtnText');
      const btnSpinner = document.getElementById('uploadSpinner');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      uploadBtn.disabled = true;
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      progressContainer.style.display = 'block';

      try {
        // Simulate progress for UX
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          progressFill.style.width = progress + '%';
          progressText.textContent = `Mengupload... ${Math.round(progress)}%`;
        }, 100);

        // Convert to base64
        const base64 = await fileToBase64(compressedFile);
        
        // Update Firestore directly (NO STORAGE NEEDED!)
        await updateDoc(doc(db, 'orders', orderDocId), {
          proofImage: base64,
          status: 'MENUNGGU KONFIRMASI',
          proofUploadedAt: Timestamp.now()
        });

        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Upload selesai!';

        // Update local state
        currentOrder.proofImage = base64;
        currentOrder.status = 'MENUNGGU KONFIRMASI';

        toast('üéâ Bukti transfer berhasil diupload!', 'success');
        
        setTimeout(() => {
          updateUI();
        }, 1000);

      } catch (error) {
        console.error('Upload error:', error);
        toast('Gagal upload: ' + error.message, 'error');
        
        uploadBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
        progressContainer.style.display = 'none';
      }
    });

    // Check maintenance
    async function checkMaintenance() {
      try {
        const settingsDoc = await getDoc(doc(db, 'settings', 'general'));
        if (settingsDoc.exists() && settingsDoc.data().maintenanceMode) {
          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('maintenancePage').style.display = 'flex';
          return true;
        }
      } catch (e) {
        console.log('Settings check error:', e);
      }
      return false;
    }

    // Initialize
    async function init() {
      const isMaintenance = await checkMaintenance();
      if (!isMaintenance) {
        loadOrder();
      }
    }

    init();
  </script>
</body>
</html>